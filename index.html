<!DOCTYPE html>
<html>
<head>
	<title>splitcode helper</title>
	<style type="text/css">
	  /* Basic styles */
	  
	  body {background: #9CA7B7; margin: 10px; font-size: 14px}
	  a {color: #222277; text-decoration: none }
	  a:hover {color: #222277; text-decoration: underline }
	  img {border: 0; }
	  code {white-space: pre; font-family: monospace }
	  
	  /* Page styles */
	  
	  #container {width: 1250px; margin: 0 auto; }
	  #content {float: left; padding: 0; background-color: #FFFFFF; font-size: 22px; min-height: 450px; width: 100%; font-family: Verdana,sans-serif;}
	  #content #wrapper {padding: 0 10px; margin-top: 10px}
	  #content #wrapper p {margin-top: 6px; font-size: 20px}
	  
	  /* Header */
	  
	  #header {background: rgb(0,45,110); color: white; padding: 35px 20px 35px 20px; }
	  #header #logo {font-size: 24pt; font-family: Verdana,sans-serif; font-weight: bold; }
	  #header #external {float: right; font-size: 14pt;}
	  #header #external a {color: white; text-decoration: none; border: 2px #EEEEEE solid; padding: 4px;}
	  #header #external a:hover {text-decoration: underline}
	  
	  h1.page_head {font-size: 17pt; font-family: Times,serif; color: #333333; border-bottom: 1px solid #AAAAAA; margin: 0 0 10px 0}
	  
	  /* Checkbox menu */
	  
	  .checkbox_menu_header {font-size: 14px; border: 1px solid black; width: 200px; padding-left: 4px; padding-top: 4px; padding-bottom: 4px; cursor: pointer; user-select: none}
	  .checkbox_menu_header .arrow::before {border-style: solid; border-width: 0.15em 0.15em 0 0; content: ''; display: inline-block; height: 0.85em; left: 0.15em; top: 0.15em; vertical-align: top; width: 0.85em; transform: rotate(135deg); float: right; margin-right: 6px;}
	  .checkbox_menu_header .arrow_selected::before {border-style: solid; border-width: 0 0 0.15em 0; content: ''; display: inline-block; height: 0.85em; bottom: 0.15em; vertical-align: top; width: 0.85em; transform: rotate(0deg); float: right; margin-right: 6px;}
	  ul.checkbox_menu {padding: 0; list-style-type: none; margin: 0; border: 1px solid black; }
	  ul.checkbox_menu li {list-style: none;}
	  
	  /* Test run */
	  
	  #test_run_input_sequences label {display: block; font-size: 14px}
	  #test_run_input_sequences textarea {width: 80%; display: block;}
	  #test_run_input_sequences input {display: inline;}
	  #test_run_output label {display: block; font-size: 14px;}
	  #test_run_output textarea {width: 80%;}
	  #command_text label {display: block; font-size: 14px}
	  #command_text textarea {width: 80%;}
	  
	  /* Footer */
	  
	  #footer {text-align: center; color: #FFFFFF; padding: 5px; background: rgb(0,45,110); font-family: Verdana,sans-serif; clear: both; }
	  
	  /* Other */
	  
	  table.config_table {border: 1px solid black; border-spacing: 0 0; width: 2200px;}
	  table.config_table tr.table_header th {font-size: 12px; border-bottom: 2px solid black; background-color: #DDDDDD; border-top: 1px solid black; border-right: 2px solid black;}
	  table.config_table tr.table_subheader th {font-size: 10px; font-weight: normal; border-bottom: 2px solid black; background-color: #DDDDDD; border-right: 2px solid black;}
	  table.config_table input {display: block; vertical-align: middle; margin: auto }
	  table.config_table select {display: block; vertical-align: middle; margin: auto }
	  table.config_table td {padding-top: 4px; padding-bottom: 4px;}
	  table.config_table tr.odd {background: #DDDDDD; text-align: center;}
	  table.config_table tr.even {text-align: center;}
	  table.config_table td.border_right {border-right: 1px solid black;}
	  table.config_table tr span {font-size: 12px;}
	  #config_header label {font-size: 14px;}
	  #config_header span {font-size: 10px;}
	  #config {overflow: auto;}
	  #config_header_section {display: block; margin-bottom: 5px}
	  table.groups_table {border: 1px solid black; border-spacing: 0 0; width: 360px; margin-top: 10px;}
	  table.groups_table tr.table_header th {font-size: 12px; border-bottom: 2px solid black; background-color: #DDDDDD; border-top: 1px solid black; border-right: 2px solid black;}
	  table.groups_table input {display: block; vertical-align: middle; margin: auto }
	  table.groups_table td {padding-top: 4px; padding-bottom: 4px;}
	  table.groups_table tr span {font-size: 12px; display: block;}

	</style>
	<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
	<script>
		var timeOuts = new Array();
		function getComplementaryPairs(strand)
		{
			var new_strand = "";
			for (i = 0; i < strand.length; i++)
			{
				if (strand.charAt(i) == 'A')
					new_strand += 'T'
				else if (strand.charAt(i) == 'T')
					new_strand += 'A'
				else if (strand.charAt(i) == 'C')
					new_strand += 'G'
				else if (strand.charAt(i) == 'G')
					new_strand += 'C'
			}
			return new_strand;
		}

		function updateStrand(new_strand, template_strand, j, end)
		{
			if (!end)
			$($(".dna").get(j)).html('<div style="background-color: #DDD">' + drawStrand(new_strand, template_strand, end) + '</div>');
			else
			$($(".dna").get(j)).html(drawStrand(new_strand, template_strand, end));
		} 

function callUpdate(new_strand, reversed_dna, j, end) {
    return function() {
        updateStrand(new_strand, reversed_dna, j, end);
    };
}

		function getRandomDNASequence()
		{
			var dna = "";
			var len = 25 + Math.floor(40 * Math.random());
			for( var i=0; i < len; i++ )
				dna += "ATCG".charAt(Math.floor(4 * Math.random()));
			$("#dna_sequence").val(dna);

		}

			function clearAllTimeouts(){  
  					for(key in timeOuts ){  
  					  clearTimeout(timeOuts[key]);  
  					} 
			}

		function generateDNA(dna, terminating_base)
		{

			$("#activity").hide();
			$("#activity_2").show();
			$(".saved").show();
			$(".saved").click(function() {  clearAllTimeouts();  $("#activity").show(); $("#activity_2").hide(); $(".saved").hide(); });

			var reversed_dna = dna.split("").reverse().join("");
			var primer = getComplementaryPairs(reversed_dna.substring(0, 18));
			terminating_base = getComplementaryPairs(terminating_base);
			var numterm = numTerminators(reversed_dna.substring(18, dna.length), terminating_base);
			$("#activity_2").html("<p>Dideoxy Chain Termination Reaction:</p>");
			for (i = 0; i < numterm; i++)
			{
				$("#activity_2").html($("#activity_2").html() + '<div class="dna"></div><br />');
			}
			$(".dna").html(drawStrand(primer, reversed_dna, 0));

			var iter_times = reversed_dna.length - primer.length;
			var count = 0;
			for (var j = 0; j < numterm; j++)
			{
				var i = 0;
				var new_strand = primer;
				var ignore = 0;
				while (i < iter_times)
				{
					count++;
					if (reversed_dna.charAt(primer.length + i) == terminating_base)
					{
						if (ignore == j)
						{
							new_strand += getComplementaryPairs(reversed_dna.charAt(new_strand.length));
							timeOuts["a" + count] = setTimeout(callUpdate(new_strand, reversed_dna, j, 1),
							600*count);
							break;
						}
						ignore++;
					}
					i++;
					new_strand += getComplementaryPairs(reversed_dna.charAt(new_strand.length));
					timeOuts["b" + count] = setTimeout(callUpdate(new_strand, reversed_dna, j, 0),
						600*count);
				}
			}
			$("#activity_2").html($("#activity_2").html() + '<p><ul><li style="color: #444">The dark nucleotides form the template strand</li><li style="color: purple">The purple nucleotides form the DNA primer</li><li style="color: #A1A1D8">The light blue nucleotides are the dNTPs added to the 3\' end of the growing DNA strand.</li><li style="color: red">The red nucleotides are the dideoxynucleotides (i.e. the chain-terminating nucleotides)</li></ul></p>');
		}
		
		var curr_id = 0;
		var n_groups = 0;
		var curr_id_out = 0;

		function eventRegistration() {
		  $("#config_menu_1_header").click(function() {
		    if(!$("#config_menu_1").is(":visible")) {
		      $("#config_menu_1").show(500);
		      $("#config_menu_1_header").find('span').first().attr('class', 'arrow_selected');
		    } else {
		      $("#config_menu_1").hide(500);
		      $("#config_menu_1_header").find('span').first().attr('class', 'arrow');
		    }
		  });
		  $("#nFastqs").on('input', function() {
		    var nFastqs_curr = Number($("#nFastqs").val());
		    for (i = 0; i < curr_id; i++) {
		      var x = $("#select_fastq_files_" + i).val();
		      if (x >= nFastqs_curr) {
		        alert("Error: Can't reduce number of FASTQ files because there is currently a file specified in the locations column that would exceed the number of FASTQ files");
		        $("#nFastqs").val(nFastqs_curr+1); // reset to previous value then return
		        return;
		      }
		    }
		    for (i = 0; i < curr_id; i++) {
		      var x = $("#select_fastq_files_" + i).val();
		      $("#select_fastq_files_" + i).html(getFastqFileOptionsMenu(x));
		    }
		  });
		}

		function getFastqFileOptionsMenu(selected_val = -1) {
		  var nFastqs_curr = $("#nFastqs").val();
		  var rows_str = '<option value="-1">Any file</option>';
		  for (j = 0; j < nFastqs_curr; j++) {
		    rows_str += '<option value="' + j + '"';
		    if (j == selected_val) {
		      rows_str += ' selected="selected"'
		    }
		    rows_str += '>File ' + j + '</option>';
		  }
		  return rows_str;
		}
		
		var group_offset = 1000000;
		
		function updateTagsAndGroups() {
		// get all tag IDs and group ID up through curr_id
		  var tag_arr = [];
		  var group_arr = [];
		  for (j = 0; j < curr_id; j++) {
		    var tagname = $("#tag_name_" + j).val().trim();
		    if (tagname.length != 0) {
		      tag_arr.push(tagname);
		    }
		    var groupname = $("#group_name_" + j).val().trim();
		    if (groupname.length != 0) {
		      group_arr.push(groupname);
		    }
		  }
		  var tag_arr_new = [...new Set(tag_arr)];
		  var group_arr_new = [...new Set(group_arr)];
		  n_groups = group_arr_new.length;
		  var rows_str = '';
		  rows_str += '<option value="-1"></option>';
		  rows_str += '<optgroup label="tag names">';
		  var invmap = {};
		  for (j = 0; j < tag_arr_new.length; j++) {
		    invmap[tag_arr_new[j]] = j;
		    rows_str += '<option value="' + j + '"';
		    rows_str += '>' + tag_arr_new[j] + '</option>';
		  }
		  rows_str += '</optgroup>';
		  rows_str += '<optgroup label="group names">';
		  var invmap_g = {};
		  var rows_str_group = '<tr class="table_header"><th width="200px">Group name</th><th width="80px">minFinds</th><th width="80px">maxFinds</th></tr>';
		  var group_settings_map = {};
		  $("tr.group_table_row").each(function() {
		    var v1 = $(this).find("td.group_table_row_name").text();
		    var v2 = $(this).find("input.group_table_row_minfinds").val();
		    var v3 = $(this).find("input.group_table_row_maxfinds").val();
		    group_settings_map[v1] = [v2,v3];
		  });
		  for (j = group_offset; j < group_offset+group_arr_new.length; j++) {
		    var curr_g_name = group_arr_new[j-group_offset];
		    invmap_g[curr_g_name] = j;
		    rows_str += '<option value="' + j + '"';
		    rows_str += '>' + group_arr_new[j-group_offset] + '</option>';
		    if (!(curr_g_name in group_settings_map)) {
		      group_settings_map[curr_g_name] = [0,0];
		    }
		    rows_str_group += '<tr class="group_table_row"><td class="group_table_row_name"><span>' + curr_g_name + '</span></td><td><input class="group_table_row_minfinds" type="number" min="0" max="999" value="' + group_settings_map[curr_g_name][0] + '" /></td><td><input class="group_table_row_maxfinds" type="number" min="0" max="999" value="' + group_settings_map[curr_g_name][1] + '" /></td></tr>';
		  }
		  $("#activity_1_groups").html(rows_str_group); // Prepare the groups table
		  rows_str += '</optgroup>';
		  for (j = 0; j < curr_id; j++) {
		    var selection_val = $("#select_tags_next_" + j).val();
		    var selection = -1;
		    var addition = '';
		    if (selection_val != null && selection_val != -1) {
		      selection = $("#select_tags_next_" + j + " :selected").text();
		      if (selection_val >= group_offset || selection_val == -3) { // selected a group
		        if (!(selection in invmap_g)) {
		          var addition = '<optgroup label="undefined"><option value="-3" selected="selected">' + selection + '</option></optgroup>';
		          $("#select_tags_next_" + j).html(rows_str + addition);
		          continue;
		        }
		      } else if (!(selection in invmap)) {
		        var addition = '<optgroup label="undefined"><option value="-2" selected="selected">' + selection + '</option></optgroup>'; 
		        $("#select_tags_next_" + j).html(rows_str + addition);
		        continue;
		      }
		    }
		    $("#select_tags_next_" + j).html(rows_str);
		    $("#select_tags_next_" + j).val(selection_val >= group_offset || selection_val == -3 ? invmap_g[selection] : invmap[selection]);
		  }
		  for (j = 0; j < curr_id; j++) {
		    var selection_val = $("#select_tags_previous_" + j).val();
		    var selection = -1;
		    var addition = '';
		    if (selection_val != null && selection_val != -1) {
		      selection = $("#select_tags_previous_" + j + " :selected").text();
		      if (selection_val >= group_offset || selection_val == -3) { // selected a group
		        if (!(selection in invmap_g)) {
		          var addition = '<optgroup label="undefined"><option value="-3" selected="selected">' + selection + '</option></optgroup>';
		          $("#select_tags_previous_" + j).html(rows_str + addition);
		          continue;
		        }
		      } else if (!(selection in invmap)) {
		        var addition = '<optgroup label="undefined"><option value="-2" selected="selected">' + selection + '</option></optgroup>'; 
		        $("#select_tags_previous_" + j).html(rows_str + addition);
		        continue;
		      }
		    }
		    $("#select_tags_previous_" + j).html(rows_str);
		    $("#select_tags_previous_" + j).val(selection_val >= group_offset || selection_val == -3 ? invmap_g[selection] : invmap[selection]);
		  }
		}
		
		function handleChangeTrimCheckbox(id) {
		  if ($("#trim_right_checkbox_" + id).is(':checked')) {
		    $("#trim_left_checkbox_" + id).attr("disabled","disabled");  
		    $("#trim_right_inputoffset_" + id).css("visibility","visible");   
		  } else {
		    $("#trim_left_checkbox_" + id).removeAttr("disabled");
		    $("#trim_right_inputoffset_" + id).css("visibility","hidden");
		  }
		  if ($("#trim_left_checkbox_" + id).is(':checked')) {
		    $("#trim_right_checkbox_" + id).attr("disabled","disabled");
		    $("#trim_left_inputoffset_" + id).css("visibility","visible");
		  } else {
		    $("#trim_right_checkbox_" + id).removeAttr("disabled");
		    $("#trim_left_inputoffset_" + id).css("visibility","hidden"); 
		  }
		}
		
		function addConfigRows() {
		  var rows_str = "";
		  var default_group_name = (n_groups > 0 || curr_id == 0 ? "groupA" : "");
		  for (i = 0; i < 4; i++) {
		    if (i % 2 == 0) {
		      rows_str += '<tr class="even">';
		    } else {
		      rows_str += '<tr class="odd">';
		    }
		    rows_str += '<td class="border_right"><input type="text" id="tag_seq_' + curr_id + '" value="" size="32" placeholder="Enter tag sequence" pattern="([ ]*)([ATCGatcg/]*)([ ]*)" /></td>';
		    rows_str += '<td class="border_right"><input type="text" onchange="updateTagsAndGroups()" id="tag_name_' + curr_id + '" value="tag' + curr_id + '" size="10" placeholder="tag name" pattern="([ ]*)([a-zA-Z0-9/:;<>+=!,.$%_&?*~`\'\^\-]*)([ ]*)" /></td>';
		    rows_str += '<td class="border_right"><input type="text" onchange="updateTagsAndGroups()" id="group_name_' + curr_id + '" value="' + default_group_name + '" size="10" placeholder="group name" pattern="([ ]*)([a-zA-Z0-9/:;<>+=!,.$%_&?*~`\'\^\-]*)([ ]*)" /></td>';
		    rows_str += '<td><input id="d_substitutions_' + curr_id + '" type="number" min="0" max="6" value="0" /></td><td><input id="d_indels_' + curr_id + '" type="number" min="0" max="3" value="0" /></td><td class="border_right"><input id="d_total_' + curr_id + '" type="number" min="0" max="9" value="0" /></td>';
		    rows_str += '<td><select name="select_fastq_files" id="select_fastq_files_' + curr_id + '" style="width: 75px">';
		    rows_str += getFastqFileOptionsMenu();
		    rows_str += '</select></td><td><input id="start_pos_' + curr_id + '" type="number" min="0" max="99999" value="0" /></td><td class="border_right"><input id="end_pos_' + curr_id + '" type="number" min="0" max="99999" value="0" /></td>';
		    rows_str += '<td class="border_right"><input id="minfinds_' + curr_id + '" type="number" min="0" max="999" value="0" /></td>';
		    rows_str += '<td class="border_right"><input id="maxfinds_' + curr_id + '" type="number" min="0" max="999" value="0" /></td>';
		    rows_str += '<td class="border_right"><input id="initiator_checkbox_' + curr_id + '" type="checkbox" /></td>';
		    rows_str += '<td class="border_right"><input id="terminator_checkbox_' + curr_id + '" type="checkbox" /></td>';
		    rows_str += '<td class="border_right"><input id="exclude_checkbox_' + curr_id + '" type="checkbox" /></td>';
		    rows_str += '<td><input type="checkbox" id="trim_left_checkbox_' + curr_id + '" onchange="handleChangeTrimCheckbox(' + curr_id + ');" /></td><td class="border_right"><input id="trim_left_inputoffset_' + curr_id + '" style="visibility: hidden" type="number" min="-9999" max="9999" value="0" /></td>';
		    rows_str += '<td><input type="checkbox" id="trim_right_checkbox_' + curr_id + '" onchange="handleChangeTrimCheckbox(' + curr_id + ');" /></td><td class="border_right"><input id="trim_right_inputoffset_' + curr_id + '" style="visibility: hidden" type="number" min="-9999" max="9999" value="0" /></td>';
		    rows_str += '<td class="border_right"><select name="select_tags" id="select_tags_next_' + curr_id + '" style="width: 75px">';
		    rows_str += '';
		    rows_str += '</td>';
		    rows_str += '<td class="border_right"><select name="select_tags" id="select_tags_previous_' + curr_id + '" style="width: 75px">';
		    rows_str += '';
		    rows_str += '</td>';
		    rows_str += '<td class="border_right"><input type="text" id="substitution_sequence_' + curr_id + '" value="" size="32" placeholder="substitution sequence" pattern="([ ]*)(([ATCGatcgNn]*)|[.\-])([ ]*)" /></td>';
		    rows_str += '<td class="border_right"><input id="partial5_min_match_' + curr_id + '" type="number" min="0" max="9999" value="0" /></td>';
		    rows_str += '<td class="border_right"><input id="partial5_mismatch_freq_' + curr_id + '" type="number" value="0" step="0.01" min="0" max="0.99" /></td>';
		    rows_str += '<td class="border_right"><input id="partial3_min_match_' + curr_id + '" type="number" min="0" max="9999" value="0" /></td>';
		    rows_str += '<td><input id="partial3_mismatch_freq_' + curr_id + '" type="number" value="0" step="0.01" min="0" max="0.99" /></td>';
		    rows_str += '</tr>';
		    curr_id++;
		  }
		  $("#activity_1").append(rows_str);
		  updateTagsAndGroups();
		}
		
		$( document ).ready(function() {
		  addConfigRows();
		  eventRegistration();
		});
		
		function downloadConfig() {
		  var text = getConfigText();
		  if (text == '') {
		    return;
		  }
		  var element = document.createElement('a');
		  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
		  element.setAttribute('download', "config.txt");
		  element.style.display = 'none';
		  document.body.appendChild(element);
		  element.click();
		  document.body.removeChild(element);
		}
		
		function getExtractFiles() { // Returns an array of files with the first element being "" (if extraction unsuccessful, the first element is the error message)
		  // First obtain all tag names and group names (which we'll use to validate extractions that involve them)
		  var tag_arr = [];
		  var group_arr = [];
		  for (j = 0; j < curr_id; j++) {
		    var tagname = $("#tag_name_" + j).val().trim();
		    var tagseq = $("#tag_seq_" + j).val().trim();
		    if (tagname.length != 0 && tagseq.length != 0) {
		      tag_arr.push(tagname);
		    }
		    var groupname = $("#group_name_" + j).val().trim();
		    if (groupname.length != 0 && tagseq.length != 0) {
		      group_arr.push(groupname);
		    }
		  }
		  tag_arr = [...new Set(tag_arr)];
		  group_arr = [...new Set(group_arr)];
		  
		  // Now parse the extraction string specified
		  var extract_pattern_str = $("#extraction_pattern").val().trim().replace(/\s+/g, '');
		  var extract_pattern = extract_pattern_str.split(',');
		  var files = [""];
		  for (var i = 0; i < extract_pattern.length; i++) {
		    var str = extract_pattern[i];
		    var name = "";
		    var begin = false;
		    var end = false;
		    var tag_extract_begin = false;
		    var tag_extract_group = false;
		    var tag_extract_name = "";
		    for (var j = 0; j < str.length; j++) {
		      if (str[j] == '<') {
		        begin = true;
		      } else if (str[j] == '>' || str[j] == '{' || str[j] == '[') {
		        end = true;
		        if (str[j] == '>') {
		          break;
		        } else if (str[j] == '{') {
		          tag_extract_begin = true;
		          if (j+1 < str.length && str[j+1] == '{') {
		            tag_extract_group = true;
		          }
		        }
		      } else if (begin && !end) {
		        name += str[j];
		      } else if (end && tag_extract_begin) {
		        if (str[j] == '}') {
		          break;
		        } else {
		          tag_extract_name += str[j];
		        }
		      }
		    }
		    if (tag_extract_name != "") {
		      var success = true;
		      if (tag_extract_group && !group_arr.includes(tag_extract_name)) { // lookup if valid group name
		        success = false;
		      } else if (!tag_extract_group && !tag_arr.includes(tag_extract_name)) { // lookup if valid tag name
		        success = false;
		      }
		      if (!success) {
		        return ["The following name does not exist: \"" + tag_extract_name + "\""];
		      }
		    }
		    if (name != "") {
		      files.push(name);
		    }
		  }
		  return files;
		}
		
		function getConfigText(validity_check_only=false) {
		  updateTagsAndGroups();
		  if (!$("#config_form")[0].checkValidity()) {
		    $("#config_form")[0].reportValidity();
		    return "";
		  }
		  if (validity_check_only) { // If we only cared about performing the validity check above, just return early
		    return "";
		  }
		  var text = "";
		  var extract_pattern_str = $("#extraction_pattern").val().trim().replace(/\s+/g, '');
		  if (extract_pattern_str != "") {
		    var ret = getExtractFiles();
		    if (ret[0] != "") {
		      alert("Error in extraction pattern: " + ret[0]);
		      return "";
		    }
		    text += "@extract " + extract_pattern_str + "\n";
		  }
		  var columns = ["groups","ids","tags","distances","locations","minFinds","maxFinds","minFindsG","maxFindsG","exclude","subs","next","previous","left","right","partial5","partial3"];
		  var number_of_groups = 0;
		  var group_settings_map = {};
		  var group_settings_sum_minfinds = 0;
		  var group_settings_sum_maxfinds = 0;
		  $("tr.group_table_row").each(function() {
		    var v1 = $(this).find("td.group_table_row_name").text();
		    var v2 = $(this).find("input.group_table_row_minfinds").val();
		    var v3 = $(this).find("input.group_table_row_maxfinds").val();
		    group_settings_map[v1] = [v2,v3];
		    group_settings_sum_minfinds += v2;
		    group_settings_sum_maxfinds += v3;
		    number_of_groups++;
		  });
		  // TODO: UMI Extraction (can splitcode run successfully with only @options and no tags given?) and other @options
		  // // extraction options: name (which can overlap with others' names -- probs print out warning), before/after (either group or location), other-before/after (if not sandwiching), multiple extractions [comma-separated]
		  // TODO: Loading in: Enforce having tag name (by setting defaults if blank); careful w/ minFindsG/maxFindsG and initiator/terminator
		  // TODO: Null group/tag reference in extraction or in prev/next: Probably just ignore (and rely on splitcode program to spit out error)
		  // TODO: File whitelist upload option
		  // TODO: help popups
		  // TODO: tutorial
		  var number_of_tags = 0;
		  var number_of_distances = 0;
		  var number_of_locations = 0;
		  var number_of_minfinds = 0;
		  var number_of_maxfinds = 0;
		  var number_of_exclude = 0;
		  var number_of_left = 0;
		  var number_of_right = 0;
		  var number_of_next = 0;
		  var number_of_previous = 0;
		  var number_of_substitution_seqs = 0;
		  var number_of_partial5 = 0;
		  var number_of_partial3 = 0;
		  for (j = 0; j < curr_id; j++) { // Initial iteration through table (to see which columns are used and for input validation)
		    var tagseq = $("#tag_seq_" + j).val().trim();
		    var tagname = $("#tag_name_" + j).val().trim();
		    if (tagname.length == 0 && tagseq.length != 0) {
		      alert("Error: One of the rows has a tag sequence specified in the 'tags' column but no tag name specified in the 'ids' column");
		      return "";
		    }
		    if (tagseq.length != 0) {
		      number_of_tags++;
		    } else {
		      continue; // Row with no tag sequence; just ignore it
		    }
		    var d_subs = $("#d_substitutions_" + j).val();
		    var d_indels = $("#d_indels_" + j).val();
		    var d_total = $("#d_total_" + j).val();
		    if (d_subs > 0 || d_indels > 0) {
		      number_of_distances++;
		    }
		    var loc_file = $("#select_fastq_files_" + j).val();
		    var loc_start_pos = $("#start_pos_" + j).val();
		    var loc_end_pos = $("#end_pos_" + j).val();
		    if (!(loc_file == -1 && loc_start_pos == 0 && loc_end_pos == 0)) {
		      number_of_locations++;
		    }
		    if (loc_end_pos <= loc_start_pos && loc_end_pos != 0) {
		      alert("Error: The 'locations' column of the following tag is malformed: " + tagname);
		      return "";
		    }
		    var min_finds = $("#minfinds_" + j).val();
		    var max_finds = $("#maxfinds_" + j).val();
		    if (min_finds != 0) {
		      number_of_minfinds++;
		    }
		    if (max_finds != 0) {
		      number_of_maxfinds++;
		    }
		    var exclude_checkbox = $("#exclude_checkbox_" + j).is(':checked');
		    if (exclude_checkbox) {
		      number_of_exclude++;
		    }
		    var trim_left_checkbox = $("#trim_left_checkbox_" + j).is(':checked');
		    var trim_right_checkbox = $("#trim_right_checkbox_" + j).is(':checked');
		    if (trim_left_checkbox) {
		      number_of_left++;
		    }
		    if (trim_right_checkbox) {
		      number_of_right++;
		    }
		    var selection_next_val = $("#select_tags_next_" + j).val();
		    var selection_previous_val = $("#select_tags_previous_" + j).val();
		    if (selection_next_val < -1) {
		      alert("Error: The 'next' column of the following tag is invalid: " + tagname);
		      return "";
		    }
		    if (selection_next_val != -1) {
		      number_of_next++;
		    }
		    if (selection_previous_val < -1) {
		      alert("Error: The 'previous' column of the following tag is invalid: " + tagname);
		      return "";
		    }
		    if (selection_previous_val != -1) {
		      number_of_previous++;
		    }
		    var sub_seq = $("#substitution_sequence_" + j).val().trim();
		    if (sub_seq.length != 0) {
		      number_of_substitution_seqs++;
		    }
		    var partial5_min_match = $("#partial5_min_match_" + j).val();
		    var partial5_mismatch_freq = $("#partial5_mismatch_freq_" + j).val();
		    var partial3_min_match = $("#partial3_min_match_" + j).val();
		    var partial3_mismatch_freq = $("#partial3_mismatch_freq_" + j).val();
		    if (partial5_min_match != 0) {
		      number_of_partial5++;
		    }
		    if (partial3_min_match != 0) {
		      number_of_partial3++;
		    }
		  }
		  if (number_of_tags == 0 && text == "") { // User didn't enter any sequences and there's no other config options specified, so just return
		    return "";
		  }
		  var updated_columns = [];
		  for (j = 0; j < columns.length; j++) { // Prune unused columns
		    if (columns[j] == "groups" && number_of_groups == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "minFindsG" && group_settings_sum_minfinds == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "maxFindsG" && group_settings_sum_maxfinds == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "distances" && number_of_distances == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "locations" && number_of_locations == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "minFinds" && number_of_minfinds == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "maxFinds" && number_of_maxfinds == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "exclude" && number_of_exclude == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "left" && number_of_left == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "right" && number_of_right == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "next" && number_of_next == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "previous" && number_of_previous == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "subs" && number_of_substitution_seqs == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "partial5" && number_of_partial5 == 0) {
		      columns[j] = "";
		    } else if (columns[j] == "partial3" && number_of_partial3 == 0) {
		      columns[j] = "";
		    }
		    if (columns[j] != "") {
		      updated_columns.push(columns[j]);
		    }
		  }
		  columns = updated_columns;
		  for (j = 0; j < columns.length; j++) {
		    if (j != 0) {
		      text += "\t";
		    }
		    text += columns[j];
		  }
		  for (j = 0; j < curr_id; j++) { // Second iteration through the table: extract values from the form and put into var text
		  	var tagseq = $("#tag_seq_" + j).val().trim();
		  	if (tagseq.length == 0) {
		  	  continue; // Empty row; just ignore it
		  	}
		    var tagname = $("#tag_name_" + j).val().trim();
		    var groupname = $("#group_name_" + j).val().trim();
		    var initiator_checked = $("#initiator_checkbox_" + j).is(':checked');
		    var terminator_checked = $("#terminator_checkbox_" + j).is(':checked');
		    for (col = 0; col < columns.length; col++) {
		      if (col == 0) {
		        text += "\n";
		      } else {
		        text += "\t";
		      }
		      if (columns[col] == "groups") {
		        text += groupname;
		      } else if (columns[col] == "tags") {
		        if (initiator_checked) {
		          text += "*";
		        }
		        text += tagseq;
		        if (terminator_checked) {
		          text += "*";
		        }
		      } else if (columns[col] == "ids") {
		        text += tagname;
		      } else if (columns[col] == "distances") {
		        var d_subs = $("#d_substitutions_" + j).val();
		        var d_indels = $("#d_indels_" + j).val();
		        var d_total = $("#d_total_" + j).val();
		        text += d_subs + ":" + d_indels + ":" + d_total;
		      } else if (columns[col] == "locations") {
		        var loc_file = $("#select_fastq_files_" + j).val();
		        var loc_start_pos = $("#start_pos_" + j).val();
		        var loc_end_pos = $("#end_pos_" + j).val();
		        text += loc_file + ":" + loc_start_pos + ":" + loc_end_pos;
		      } else if (columns[col] == "minFinds") {
		        var min_finds = $("#minfinds_" + j).val();
		        text += min_finds;
		      } else if (columns[col] == "maxFinds") {
		        var max_finds = $("#maxfinds_" + j).val();
		        text += max_finds;
		      } else if (columns[col] == "minFindsG") {
		        var min_finds_g = 0;
		        if (groupname in group_settings_map) {
		          min_finds_g = group_settings_map[groupname][0];
		        }
		        text += min_finds_g;
		      } else if (columns[col] == "maxFindsG") {
		        var max_finds_g = 0;
		        if (groupname in group_settings_map) {
		          max_finds_g = group_settings_map[groupname][1];
		        }
		        text += max_finds_g;
		      } else if (columns[col] == "exclude") {
		        var exclude_checkbox = $("#exclude_checkbox_" + j).is(':checked');
		        if (exclude_checkbox) {
		          text += "1";
		        } else {
		          text += "0";
		        }
		      } else if (columns[col] == "left") {
		        var trim_left_checkbox = $("#trim_left_checkbox_" + j).is(':checked');
		        var trim_left_offset = $("#trim_left_inputoffset_" + j).val();
		        if (trim_left_checkbox) {
		          text += "1";
		          if (trim_left_offset > 0) {
		            text += ":" + trim_left_offset;
		          }
		        } else {
		          text += "0";
		        }
		      } else if (columns[col] == "right") {
		        var trim_right_checkbox = $("#trim_right_checkbox_" + j).is(':checked');
		        var trim_right_offset = $("#trim_right_inputoffset_" + j).val();
		        if (trim_right_checkbox) {
		          text += "1";
		          if (trim_right_offset > 0) {
		            text += ":" + trim_right_offset;
		          }
		        } else {
		          text += "0";
		        }
		      } else if (columns[col] == "next") {
		        var selection_next_val = $("#select_tags_next_" + j).val();
		        var selection_next_text = $("#select_tags_next_" + j + " :selected").text();
		        if (selection_next_val >= group_offset) {
		          text += "{{" + selection_next_text + "}}";
		        } else if (selection_next_val >= 0) {
		          text += "{" + selection_next_text + "}";
		        }
		      } else if (columns[col] == "previous") {
		        var selection_previous_val = $("#select_tags_previous_" + j).val();
		        var selection_previous_text = $("#select_tags_previous_" + j + " :selected").text();
		        if (selection_previous_val >= group_offset) {
		          text += "{{" + selection_previous_text + "}}";
		        } else if (selection_previous_val >= 0) {
		          text += "{" + selection_previous_text + "}";
		        }
		      } else if (columns[col] == "subs") {
		        var sub_seq = $("#substitution_sequence_" + j).val().trim();
		        text += sub_seq;
		      } else if (columns[col] == "partial5") {
		        var partial5_min_match = $("#partial5_min_match_" + j).val();
		        var partial5_mismatch_freq = $("#partial5_mismatch_freq_" + j).val();
		        text += partial5_min_match + ":" + partial5_mismatch_freq;
		      } else if (columns[col] == "partial3") {
		        var partial3_min_match = $("#partial3_min_match_" + j).val();
		        var partial3_mismatch_freq = $("#partial3_mismatch_freq_" + j).val();
		        text += partial3_min_match + ":" + partial3_mismatch_freq;
		      }
		    }
		  }
		  return text;
		}
		
		function addFilesToArgs(argoptions, files, include_output_arg) {
		  if (files.length == 0) {
		    return argoptions;
		  }
		  var output_arg = "-o ";
		  for (var i = 0; i < files.length; i++) {
		    if (i != 0) {
		      output_arg += ",";
		    }
		    output_arg += "out_" + files[i];
		    if ($("#nFastqs").val() == 1) {
		      break;
		    }
		  }
		  if (include_output_arg) {
		    argoptions.push(output_arg);
		  }
		  for (var i = 0; i < files.length; i++) {
		    argoptions.push(files[i]);
		  }
		  return argoptions;
		}
		
		function displayCommand(argoptions) {
		  var command_display = "splitcode";
		  for (var i = 0; i < argoptions.length; i++) {
		    command_display += " " + argoptions[i];
		  }
		  $("#output_command_text").val(command_display);
		  $("#command_text").show();
		}

		function addInputSequences() {
		  var input_sequences = "";
		  curr_id_out++;
		  for (i = curr_id_out-1; i < curr_id_out; i++) {
		    input_sequences += '<label for="input_seq_' + i + '">file_' + i + '.fastq:</label><textarea id="input_seq_' + i + '" rows="8"></textarea>';
		  }
		  $("#test_run_input_sequences").append(input_sequences);
		}

	</script>
</head>
<body>
	<div id="container">
		<div id="header">
			<div id="logo">
				splitcode helper
			</div>
			<div id="external">
			  <a href="" target="_blank">splitcode docs</a> 
			  <a href="" target="_blank">splitcode github</a> 
			  <a href="" target="_blank">Pachter Lab</a>
			</div>
		</div>
		<div id="content">
		<div id="wrapper">
		<h1 class="page_head">Generate Config File</h1>
			<form id="config_form">
			  <div id="config_header">
			    <img src="https://raw.githubusercontent.com/pachterlab/splitcode/main/figures/splitcode_logo.png" height="100px" style="float: right" />
			    <p><label for="nFastqs">Number of FASTQ file(s) per run: </label><input type="number" value="1" min="1" max="99" id="nFastqs" name="nFastqs" /> <span>(e.g. specify 2 for paired-end)</span></p>
			    <div>
			      <!--<p><label for="extraction_name">Extraction: </label><input type="text" value="" id="extraction_name" placeholder="Extraction identifier " /></p>
			      <p><input type="checkbox" id="extraction_rev_comp_checkbox" /><label for="extraction_rev_comp_checkbox">Reverse complement extracted sequence</label></p>
			      <p><input type="radio" checked="checked" /><label>None</label><br /><input type="radio" /><label>Left barcode-before</label><br /><input type="radio" /><label>Left location-before</label></p>-->
			      <p><label for="extraction_pattern">Extraction pattern:</label> <input type="text" value="" id="extraction_pattern" size="100" pattern="([ ]*)((((((([0-9]+)((:([0-9]+))|(:-1)))|((((\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\})|(\{\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\}\}))([0-9]*))))?)<(~)?([a-zA-Z0-9_\-/]+)((\[([0-9]+)((-([0-9]+))?)\])?)(((\{(@|#)?([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\})|(\{\{(@|#)?([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\}\}))?)>(((([0-9]+)((:([0-9]+))|(:-1)))|((([0-9]*)((\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\})|(\{\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\}\})))))?)))?)((([ ]*),([ ]*)((((([0-9]+)((:([0-9]+))|(:-1)))|((((\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\})|(\{\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\}\}))([0-9]*))))?)<(~)?([a-zA-Z0-9_\-/]+)((\[([0-9]+)((-([0-9]+))?)\])?)(((\{(@|#)?([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\})|(\{\{(@|#)?([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\}\}))?)>(((([0-9]+)((:([0-9]+))|(:-1)))|((([0-9]*)((\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\})|(\{\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\}\})))))?)))*)([ ]*)" /></p>
			      <!-- (((\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\})|(\{\{([a-zA-Z0-9/:;+=!,.$%_&?*~`'\^\-]+)\}\}))([0-9]*)) -->
			      <!-- // TODO: Allow string containing only spaces? Fix commas? (a)?(,a)*, Space removal  -->
			      <!-- // // enable custom edit (no), extraction options: name (which can overlap with others' names -- probs print out warning), before/after (either group or location -- radio), other-before/after (if not sandwiching), multiple extractions [comma-separated], use_sub_sequence (#), use_read_sequence (@barcode), append (separate form), identified_tag_sequences_stitched_together-->
			      <div id="config_header_section">
			        <div class="checkbox_menu_header" id="config_menu_1_header">Output options<span class="arrow"></span></div>
			        <ul class="checkbox_menu" id="config_menu_1" style="display: none">
			          <li><input type="checkbox" id="out_opt_pipe" /> <label for="out_opt_pipe">Interleave and stream to standard output instead of separate FASTQ files (--pipe)</label></li>
			          <li><input type="checkbox" id="out_opt_mod_names" /> <label for="out_opt_mod_names">Put identified tag names in sequence identifier (--mod-names)</label></li>
			        </ul>
			      </div>
			    </div>
			  </div>
			  <div id="config">
			    <table id="activity_1" class="config_table">
			      <tr class="table_header">
			        <th rowspan="2">tags</th>
			        <th rowspan="2">ids</th>
			        <th rowspan="2">groups</th>
			        <th colspan="3">distances (error tolerance)</th>
			        <th colspan="3">locations</th>
			        <th rowspan="2">minFinds</th>
			        <th rowspan="2">maxFinds</th>
			        <th rowspan="2">initiator</th>
			        <th rowspan="2">terminator</th>
			        <th rowspan="2">exclude</th>
			        <th rowspan="2" colspan="2">left<span style="font-weight: normal"> (trim)</span></th>
			        <th rowspan="2" colspan="2">right<span style="font-weight: normal"> (trim)</span></th>
			        <th rowspan="2">next</th>
			        <th rowspan="2">previous</th>
			        <th rowspan="2">subs</th>
			        <th colspan="2">partial5</th>
			        <th colspan="2">partial3</th>
			      </tr>
			      <tr class="table_subheader">
			        <th width="80px">substitutions</th>
			        <th width="80px">indels</th>
			        <th width="80px">total</th>
			        <th width="90px">file</th>
			        <th width="90px">start position</th>
			        <th width="90px">end position</th>
			        <th width="80px">min match</th>
			        <th width="95px">mismatch freq</th>
			        <th width="80px">min match</th>
			        <th width="95px">mismatch freq</th>
			      </tr>
			  </table>
			  <table id="activity_1_groups" class="groups_table">
			  </table>
			  <div id="activity_1_submit_button">
			    <input type="button" value="Download config" onclick="downloadConfig()" />
			    <input type="button" value="Add more rows" onclick="addConfigRows()" />
			  </div>
			  <br />
			  </div>
			</form>
			<!-- <p>Please enter a DNA sequence:<br />5' <input type="text" size="100" id="dna_sequence" name="dna_sequence" /> 3'</p><p><input type="button" value="Start reaction" onclick="startReaction()" /> <input type="button" onclick="getRandomDNASequence()" value="Generate random DNA sequence" /></p> -->
			<div style="display: none" id="activity_2"></div>
			<p><input class="saved" type="button" value="Return to previous page" style="display: none" /></p>
		<h1 class="page_head">Test Run</h1>
		<div id="test_run">
		  <div id="test_run_input_sequences">
		  </div>
		  <div>
		      <input type="button" onclick="runSplitcode()" value="Run" />
		      <input type="button" onclick="addInputSequences()" value="Add Sequences" />
		  </div>
		  <hr />
		  <div id="command_text" style="display: none">
		    <label for="output_command_text">Command:</label>
		      <textarea id="output_command_text" rows="3" readonly="readonly"></textarea>
		  </div>
		  <div id="test_run_output" style="display: none">
		    <div id="stdout_output">
		    <label for="output">Output:</label>
		      <textarea class="emscripten" id="output" rows="8" readonly="readonly"></textarea>
		    </div>
		    <div id="stderr_output" style="display: none">
		    <label for="error">Output:</label>
		      <textarea class="emscripten" id="error" rows="8" readonly="readonly"></textarea>
		    </div>
		    <div id="output_file_output" style="display: none">
		    </div>
		  </div>
		</div>
		</div>
		</div>
		<div id="footer">
			Sullivan DK, Pachter L. (2023) splitcode. http://github.com/pachterlab/splitcode.
		</div>
	</div>
	
<script type='text/javascript'>
      //var statusElement = document.getElementById('status');

      var Module = {
        preRun: [],
        postRun: [],
        print: (function(text) {
          var element = document.getElementById('output');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            element.value += text + "\n";
            //if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            // These replacements are necessary if you render to raw HTML
            //text = text.replace(/&/g, "&amp;");
            //text = text.replace(/</g, "&lt;");
            //text = text.replace(/>/g, "&gt;");
            //text = text.replace('\n', '<br>', 'g');
            //console.log(text);
            //if (element) {
              //element.value += text + "\n";
              //element.scrollTop = element.scrollHeight; // focus on bottom
            //}
          };
        })(),
        printErr: (function(text) {
          var element = document.getElementById('error');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            console.log(text);
            if (!text.startsWith("program exited (with status")) { // suppress emscripten error message about EXIT_RUNTIME not being set
              element.value += text + "\n";
            }
        };
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.last.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
          } else {
          }
          //statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
      window.onerror = function() {
        Module.setStatus('Exception thrown, see JavaScript console');
        Module.setStatus = function(text) {
          if (text) console.error('[post-exception status] ' + text);
        };
      };
function runSplitcode() {
var first_empty = -1;
var last_full = -1;
var num_valid_fastq = 0;
var num_fastq = 0;
for (i = 0; i < curr_id_out; i++) {
  var x = ($("#input_seq_" + i).val()).trim();
  if (x.length == 0) {
    if (first_empty == -1) {
      first_empty = i;
    }
  } else {
    num_fastq++;
    last_full = i;
    var lines = x.split('\n');
    var found_at = false
    var found_plus = false;
    for (var j = 0; j < lines.length; j++) {
      if (lines[j].length > 0 && lines[j][0] == '@') {
        found_at = true;
      } else if (lines[j].length > 0 && lines[j][0] == '+' && found_at) {
        found_plus = true;
      }
    }
    if (found_at && found_plus) {
      num_valid_fastq++;
    }
  }
  //FS.writeFile('file_' + (i) + ".fastq", aaa);
}
// Extract config
var config_text = getConfigText();
if (config_text == "") {
  alert("Config empty or invalid");
  getConfigText(true); // run this function again to invoke reportValidity() in case we need to (since reportValidity() disappears after alert)
  return;
}
// Prepare command args
var argoptions = ['--webasm', '-c config.txt', '-N ' + $("#nFastqs").val()];
var use_pipe = false;
if ($('#out_opt_pipe').is(':checked')) {
  argoptions.push('--pipe');
  use_pipe = true;
}
if ($('#out_opt_mod_names').is(':checked')) {
  argoptions.push('--mod-names');
}
mainfiles = [];
var ret_false = false;
if (last_full == -1) {
  //alert("No input sequences supplied");
  ret_false = true;
} else if (first_empty != -1 && first_empty < last_full) {
  alert('Error: file_' + (first_empty) + ".fastq is empty");
  ret_false = true;
} else if (num_fastq % $("#nFastqs").val() != 0) {
  alert("Error: Number of input sequences provided must be a multiple of the specified number of FASTQ file(s) per run.");
  ret_false = true;
} else if (num_valid_fastq == 0) {
  var answer = window.confirm("Input sequences are not in FASTQ format; attempt to convert them to FASTQ?");
  if (answer) {
    for (i = 0; i < curr_id_out; i++) {
      var converted = "";
      var x = ($("#input_seq_" + i).val()).trim();
      if (x.length != 0) {
        var lines = x.split('\n');
        for (var j = 0; j < lines.length; j++) {
          if (j != 0) {
            converted += "\n";
          }
          converted += "@read" + (j+1) + "\n" + lines[j] + "\n" + "+" + "\n" + "K".repeat(lines[j].length);
        }
        $("#input_seq_" + i).val(converted);
      }
    }
  }
  ret_false = true;
} else if (num_valid_fastq < num_fastq) {
  alert("Error: Some input sequences are not valid FASTQ files");
  ret_false = true;
}
if (ret_false) { // i.e. if user didn't input valid FASTQs
  for (i = 0; i < $("#nFastqs").val(); i++) {
    mainfiles.push('file_' + i + '.fastq'); // Since user didn't input valid FASTQs, just use default file names when displaying command
  }
  argoptions = addFilesToArgs(argoptions, mainfiles, !use_pipe);
  displayCommand(argoptions.slice(1));
  return; // Return now; can't proceed further since FASTQs aren't valid
}
for (i = 0; i < curr_id_out; i++) {
  var x = ($("#input_seq_" + i).val()).trim();
  if (x.length != 0) {
    mainfiles.push('file_' + i + '.fastq');
    FS.writeFile('file_' + i + '.fastq', x);
  }
}
argoptions = addFilesToArgs(argoptions, mainfiles, !use_pipe);
FS.writeFile('config.txt', config_text);
var element = document.getElementById('output');
element.value = '';
$("#output").val("");
$("#error").val("");
$("#test_run_output").show();
if (use_pipe) {
  $("#stdout_output").show();
} else {
  $("#stdout_output").hide();
}
$("#output_file_output").hide();
displayCommand(argoptions.slice(1));
var x = callMain(argoptions);
if (x != 0) {
  $("#output").val($("#error").val());
  $("#stdout_output").show();
  return;
}
if (!use_pipe) {
  // Show main output files:
  var out = "";
  var l = 0;
  if ($("#nFastqs").val() == 1) {
    l = 1;
  } else {
    l = mainfiles.length;
  }
  for (var i = 0; i < l; i++) {
    out += '<label for="output_' + i + '">Output: ' + "out_" + mainfiles[i] + '</label>';
    out += '<textarea class="emscripten" id="output_' + i + '" rows="8" readonly="readonly"></textarea>';
  }
  $("#output_file_output").html(out);
  for (var i = 0; i < l; i++) {
    $("#output_" + i).val(FS.readFile("out_" + mainfiles[i], { encoding: 'utf8' }));
  }
  $("#output_file_output").show();
}
}
</script>

<script async type="text/javascript" src="splitcode.js"></script>
</body>
</html>
